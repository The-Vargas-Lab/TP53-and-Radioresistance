---
title: "Drug + Radiation Synergy Analysis, Figure 4, S4"
author: "Aaron Petty"
date: "2025-08-12"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library("reshape2")
library("openxlsx")
library("readxl")
library("tidyverse")
library("BIGL")
```

### *Data prep for synergy analyses*

#### Make list of sheetnames from Excel file and loop through to create single dataframe for each sheet 
```{r name}
sheetnumber <- seq(1:9)
sheet_names <- c()
for (i in 1:length(sheetnumber)){
  sheet_names <- append(sheet_names, (paste0("Sheet",i)))
}
Nutlin_1 <- list()
Nutlin_2 <- list()
filename_1 <- "JHUEM2, Hec108, Hec1B -Nutlin + Rad, AP47, 5-14-21"
filename_2 <- "JHUEM2, Hec108, Hec1B -AMG232 + Rad, AP46, 5-7-21"
Drug_1 <- "Nutlin-3"
Drug_2 <- "AMG-232"
cell_lines <- c("JHUEM2", "Hec108", "Hec1B")
```
#### Read in Nutlin + Radiation data file
```{r Nutlin, results='hide'}
for (i in 1:length(sheet_names)){
  Nutlin_1[[i]] <-read_xlsx(paste0(filename_1,".xlsx"), sheet_names[i])
}
```
#### Read in AMG-232 + Radiation data file
```{r AMG, results='hide'}
for (i in 1:length(sheet_names)){
  AMG_2[[i]] <-read_xlsx(paste0(filename_2,".xlsx"), sheet_names[i])
}
```
#### Extract list of radiation doses and reverse order for use later
```{r rad}
Rad <- as.character(rev(unique(Nutlin_1[[1]]$Radiation)))
```
#### Loop through each dataframe to normalize and restructure data 

```{r}

for (i in 1:length(Nutlin_1)){
  # Take the mean of 6 replicates, and restructure, making drug doses into     rownames 
  Nutlin_1[[i]] <- melt(Nutlin_1[[i]], id = c("Dose", "Radiation"))
  Nutlin_1[[i]] <- dcast(Nutlin_1[[i]], Dose ~ Radiation, mean)
  row.names(Nutlin_1[[i]]) <- Nutlin_1[[i]]$Dose
  Nutlin_1[[i]] <- Nutlin_1[[i]][,-1]
  AMG_2[[i]] <- melt(AMG_2[[i]], id = c("Dose", "Radiation"))
  AMG_2[[i]] <- dcast(AMG_2[[i]], Dose ~ Radiation, mean)
  row.names(AMG_2[[i]]) <- AMG_2[[i]]$Dose
  AMG_2[[i]] <- AMG_2[[i]][,-1]

  # Normalize each response value to Untreated sample
  
  Nutlin_1[[i]] <- Nutlin_1[[i]]/Nutlin_1[[i]]["0", "0"]
  AMG_2[[i]] <- AMG_2[[i]]/AMG_2[[i]]["0", "0"]
  
  # In JHUEM2 and Hec108 at Radiation doses of 2, 4, 8 Gy, divide fraction surviving by 2 because plated at twice the density
  
    for (j in Rad){
    
      if(i==7 | i==8 | i==9){
      Nutlin_1[[i]][j] <- Nutlin_1[[i]][j]
      AMG_2[[i]][j] <- AMG_2[[i]][j]
    }
      
    else if (j=="0" | j=="0.5" | j=="1"){
      Nutlin_1[[i]][j] <- Nutlin_1[[i]][j]
     AMG_2[[i]][j] <- AMG_2[[i]][j]
    }
    
    else {
      Nutlin_1[[i]][j] <- (Nutlin_1[[i]][j])/2
      AMG_2[[i]][j] <- (AMG_2[[i]][j])/2
    }
  }
  
  # Transpose each table and extract to separate dataframe
  Nutlin_1[[i]] <- as.data.frame(t(Nutlin_1[[i]]))
  AMG_2[[i]] <- as.data.frame(t(AMG_2[[i]]))
  
  # Create new Radiation column for Excel labels and pivot to long form
  Nutlin_1[[i]]$Radiation <- rownames(Nutlin_1[[i]])
  Nutlin_1[[i]] <- melt(Nutlin_1[[i]], id= c("Radiation"))
  AMG_2[[i]]$Radiation <- rownames(AMG_2[[i]])
  AMG_2[[i]] <- melt(AMG_2[[i]], id= c("Radiation"))
}
```

#### For each cell line, combine 3 replicate tables, take the mean, normalize all to the maximum viability, and rename columns
```{r replicates}
k <- 1
while(k <= length(Nutlin_1)){
  Nutlin_1[[k]] <- rbind(Nutlin_1[[k]], Nutlin_1[[k+1]], Nutlin_1[[k+2]])
  Nutlin_1[[k]] <- dcast(Nutlin_1[[k]], Radiation ~ variable, mean)
  Nutlin_1[[k]] <- melt(Nutlin_1[[k]], id= c("Radiation"))
  Nutlin_1[[k]]$value <- (Nutlin_1[[k]]$value)/(max(Nutlin_1[[k]]$value))
  names(Nutlin_1[[k]])[1:3] <- c("d2", "d1", "effect")
  AMG_2[[k]] <- rbind(AMG_2[[k]], AMG_2[[k+1]], AMG_2[[k+2]])
  AMG_2[[k]] <- dcast(AMG_2[[k]], Radiation ~ variable, mean)
  AMG_2[[k]] <- melt(AMG_2[[k]], id= c("Radiation"))
  AMG_2[[k]]$value <- (AMG_2[[k]]$value)/(max(AMG_2[[k]]$value))
  names(AMG_2[[k]])[1:3] <- c("d2", "d1", "effect")
  k <- k + 3
}
```
#### Add column with cell line name
```{r cellnames}
Nutlin_1[[1]]$Cell <- cell_lines[1]
Nutlin_1[[4]]$Cell <- cell_lines[2]
Nutlin_1[[7]]$Cell <- cell_lines[3]
AMG_2[[1]]$Cell <- cell_lines[1]
AMG_2[[4]]$Cell <- cell_lines[2]
AMG_2[[7]]$Cell <- cell_lines[3]
```

#### Convert to dataframes
```{r dataframe}
Mean_1 <- as.data.frame(Nutlin_1[[1]])
Mean_2 <- as.data.frame(Nutlin_1[[4]])
Mean_3 <- as.data.frame(Nutlin_1[[7]])
Mean_4 <- as.data.frame(AMG_2[[1]])
Mean_5 <- as.data.frame(AMG_2[[4]])
Mean_6 <- as.data.frame(AMG_2[[7]])
```

#### Convert Drug (d1) and Radiation (d2) doses to numeric 

```{r numeric}
# d1 is factor, so first needs changed to character
Mean_1$d1 <- as.character(Mean_1$d1)
Mean_2$d1 <- as.character(Mean_2$d1)
Mean_3$d1 <- as.character(Mean_3$d1)
Mean_4$d1 <- as.character(Mean_4$d1)
Mean_5$d1 <- as.character(Mean_5$d1)
Mean_6$d1 <- as.character(Mean_6$d1)
Mean_1$d1 <- as.numeric(Mean_1$d1)
Mean_2$d1 <- as.numeric(Mean_2$d1)
Mean_3$d1 <- as.numeric(Mean_3$d1)
Mean_4$d1 <- as.numeric(Mean_4$d1)
Mean_5$d1 <- as.numeric(Mean_5$d1)
Mean_6$d1 <- as.numeric(Mean_6$d1)
Mean_1$d2 <- as.numeric(Mean_1$d2)
Mean_2$d2 <- as.numeric(Mean_2$d2)
Mean_3$d2 <- as.numeric(Mean_3$d2)
Mean_4$d2 <- as.numeric(Mean_4$d2)
Mean_5$d2 <- as.numeric(Mean_5$d2)
Mean_6$d2 <- as.numeric(Mean_6$d2)
```



### *Synergy analysis with BIGL*
#### Fit marginal dose response curves to data using fitMarginal function in BIGL
```{r marginals}
Marg1Fit <- fitMarginals(Mean_1, method= "nlslm", names= c(Drug_1, "Radiation"))
Marg2Fit <- fitMarginals(Mean_2, method= "nlslm", names= c(Drug_1, "Radiation"))
Marg3Fit <- fitMarginals(Mean_3, method= "nlslm", names= c(Drug_1, "Radiation"))
Marg4Fit <- fitMarginals(Mean_4, method= "nlslm", names= c(Drug_2, "Radiation"))
Marg5Fit <- fitMarginals(Mean_5, method= "nlslm", names= c(Drug_2, "Radiation"))
Marg6Fit <- fitMarginals(Mean_6, method= "nlslm", names= c(Drug_2, "Radiation"))
```

#### Use fitSurface function in BIGL to fit predicted surface using Highest Single Agent (HSA)(JHUEM2, Hec108) and Loewe models (Hec1B)
```{r surface}
Cell1Surf <- fitSurface(Mean_1, Marg1Fit, null_model = "hsa", B.CP = 50, statistic = "both")
Cell2Surf <- fitSurface(Mean_2, Marg2Fit, null_model = "hsa", B.CP = 50, statistic = "both")
Cell3Surf <- fitSurface(Mean_3, Marg3Fit, null_model = "loewe", B.CP = 50, statistic = "both")
Cell4Surf <- fitSurface(Mean_4, Marg4Fit, null_model = "hsa", B.CP = 50, statistic = "both")
Cell5Surf <- fitSurface(Mean_5, Marg5Fit, null_model = "hsa", B.CP = 50, statistic = "both")
Cell6Surf <- fitSurface(Mean_6, Marg6Fit, null_model = "loewe", B.CP = 50, statistic = "both")
```

#### Generate isobolograms of predicted surfaces using isobologram function in BIGL and save as pdfs
```{r isobol}
isobologram(Cell1Surf)

isobologram(Cell2Surf)

isobologram(Cell3Surf)

isobologram(Cell4Surf)

isobologram(Cell5Surf)

isobologram(Cell6Surf)
```

#### Generate contour plots of synergy scores using contour function in BIGL and save as pdfs
```{r contour}
contour(Cell1Surf, main= paste0("Contour Plot for ", cell_lines[1], " MaxR"))

contour(Cell2Surf, main= paste0("Contour Plot for ", cell_lines[2], " MaxR"))

contour(Cell3Surf, main= paste0("Contour Plot for ", cell_lines[3], " MaxR"))

contour(Cell4Surf, main= paste0("Contour Plot for ", cell_lines[1], " MaxR"))

contour(Cell5Surf, main= paste0("Contour Plot for ", cell_lines[2], " MaxR"))

contour(Cell6Surf, main= paste0("Contour Plot for ", cell_lines[3], " MaxR"))
```

### **Built with Version `r getRversion()`**
